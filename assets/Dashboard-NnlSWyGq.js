import{c as W,g as U,a as K,b as _,d as Q,j as e,F as A,e as G,f as z,h as B,s as ee,i as te,k as ae,l as se,m as ne,n as re,o as ce,p as oe,q as ie,r as le,t as de,u as me,v as he,w as ue,x as ge,y as D,B as xe,z as P,A as E,C as T,D as ve,E as fe,G as $,H as V}from"./index-Bd7zNR2G.js";import{r as a,c as je,L as pe,C as Ne,X as we,Y as be,T as Re,d as ye,e as He}from"./charts-Br66VyBn.js";import"./utils-frnwrks6.js";import"./react-vendor-gH-7aFTg.js";import"./ui-vendor-DNobTsNg.js";function Ce({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941"}))}const O=a.forwardRef(Ce);function ke({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 10.5h.375c.621 0 1.125.504 1.125 1.125v2.25c0 .621-.504 1.125-1.125 1.125H21M3.75 18h15A2.25 2.25 0 0 0 21 15.75v-6a2.25 2.25 0 0 0-2.25-2.25h-15A2.25 2.25 0 0 0 1.5 9.75v6A2.25 2.25 0 0 0 3.75 18Z"}))}const Se=a.forwardRef(ke);function Me({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"}))}const I=a.forwardRef(Me);function De({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z"}),a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z"}))}const Ee=a.forwardRef(De);function Te({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const Fe=a.forwardRef(Te);function $e({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"}),a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"}))}const Ae=a.forwardRef($e);function Ie({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48Z"}),a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 18a3.75 3.75 0 0 0 .495-7.468 5.99 5.99 0 0 0-1.925 3.547 5.975 5.975 0 0 1-2.133-1.001A3.75 3.75 0 0 0 12 18Z"}))}const Le=a.forwardRef(Ie);function Ze({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"}))}const ze=a.forwardRef(Ze);function Be({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z"}))}const Pe=a.forwardRef(Be);function Ve({title:t,titleId:s,...m},n){return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":s},m),t?a.createElement("title",{id:s},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const Oe=a.forwardRef(Ve),We=t=>{const s=a.useMemo(()=>t?.age?Q(t.age,t.restingHeartRate,t.maxHeartRate):W(190,60),[t?.age,t?.restingHeartRate,t?.maxHeartRate]);return{zones:s,getZoneForHeartRate:o=>_(o,s),getZoneColor:o=>K(o,s),getZoneName:o=>U(o,s)}},X=(t=190,s=60)=>{const m=a.useMemo(()=>W(t,s),[t,s]);return{zones:m,getZoneForHeartRate:u=>_(u,m),getZoneColor:u=>K(u,m),getZoneName:u=>U(u,m)}},Ue=t=>{const[s,m]=a.useState("");return a.useEffect(()=>{if(!t){m("");return}const n=()=>{const o=new Date,u=t.startTime,i=(t.endTime||o).getTime()-u.getTime(),l=Math.floor(i/1e3),v=Math.floor(l/60),c=Math.floor(v/60),g=l%60,r=v%60;let d="";c>0?d=`${c}:${r.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}`:d=`${r}:${g.toString().padStart(2,"0")}`,m(d)};n();let h=null;return t.isActive&&(h=setInterval(n,1e3)),()=>{h&&clearInterval(h)}},[t]),s},Ke=({rower:t})=>{const{getZoneColor:s,getZoneName:m,zones:n}=We(t),h=t.currentHeartRate?.heartRate,o=h?m(h):"No Data",u=h?s(h):"#6b7280",N=t.currentHeartRate?.timestamp,i=()=>t.deviceId?h?{status:"connected",icon:z,color:"text-green-500"}:{status:"connecting",icon:z,color:"text-yellow-500"}:{status:"disconnected",icon:G,color:"text-gray-400"},l=()=>{const r=t.currentHeartRate?.batteryLevel;return r===void 0?{level:null,color:"text-gray-400"}:r<=20?{level:r,color:"text-red-500"}:r<=50?{level:r,color:"text-yellow-500"}:{level:r,color:"text-green-500"}},v=i(),c=l(),g=v.icon;return e.jsxs("article",{className:"heart-rate-card",children:[e.jsxs("header",{className:"heart-rate-card-header",children:[e.jsxs("div",{className:"heart-rate-card-info",children:[e.jsx("h3",{className:"heart-rate-card-name",children:t.name}),e.jsxs("p",{className:"heart-rate-card-seat",children:["Seat ",t.seat]})]}),e.jsxs("div",{className:"heart-rate-card-status",children:[e.jsx(g,{className:`heart-rate-card-status-icon ${v.status==="connected"?"heart-rate-card-status-icon--connected":v.status==="connecting"?"heart-rate-card-status-icon--connecting":"heart-rate-card-status-icon--disconnected"}`}),e.jsx(Se,{className:`heart-rate-card-battery-icon ${c.color}`})]})]}),e.jsxs("div",{className:"heart-rate-display",children:[e.jsxs("div",{className:"heart-rate-value-container",children:[e.jsx(A,{className:"heart-rate-icon"}),e.jsx("div",{className:"heart-rate-value",style:{color:u},children:h||"--"}),e.jsx("div",{className:"heart-rate-unit",children:"BPM"})]}),e.jsx("div",{className:"heart-rate-zone-badge",style:{backgroundColor:u},children:o})]}),h&&e.jsxs("div",{className:"heart-rate-zone-progress",children:[e.jsxs("label",{htmlFor:`progress-bar-${t.id}`,className:"heart-rate-zone-labels",children:[e.jsx("span",{children:n.recovery.min}),e.jsx("span",{children:n.anaerobic.max})]}),e.jsxs("progress",{id:`progress-bar-${t.id}`,className:"heart-rate-progress-bar",max:n.anaerobic.max-n.recovery.min,value:h-n.recovery.min,style:{"--zone-color":u},"aria-label":`Heart rate progress: ${h} BPM`,children:[h," BPM"]})]}),e.jsx("div",{className:"heart-rate-last-update",children:N?`Updated ${N.toLocaleTimeString()}`:"No data received"})]})},_e={1:"#ef4444",2:"#3b82f6",3:"#10b981",4:"#f59e0b"},q=a.memo(({data:t,rowers:s,sessionStartTime:m,sessionEndTime:n})=>{const h=a.useMemo(()=>{if(t.length===0)return[];const c=[...t].sort((x,w)=>x.timestamp.getTime()-w.timestamp.getTime()),g=m?.getTime()||c[0].timestamp.getTime(),r=new Map;return c.forEach(x=>{const w=Math.floor((x.timestamp.getTime()-g)/1e3);r.has(w)||r.set(w,{});const y=r.get(w);y[`device_${x.deviceId}`]=x.heartRate,y.timestampStr=x.timestamp.toLocaleTimeString()}),Array.from(r.entries()).sort(([x],[w])=>x-w).map(([x,w])=>({duration:x,...w}))},[t,m?.getTime(),n?.getTime()]),{sessionDuration:o,xAxisTicks:u}=a.useMemo(()=>{if(h.length===0)return{sessionDuration:0,xAxisTicks:[]};let c;n&&m?c=Math.round((n.getTime()-m.getTime())/1e3):c=Math.max(...h.map(j=>j.duration))+1;const g=[0,Math.round(c*.25),Math.round(c*.5),Math.round(c*.75),c],r=[...new Set(g)].sort((d,j)=>d-j);return{sessionDuration:c,xAxisTicks:r}},[h,m,n]),N=a.useMemo(()=>s.filter(c=>c.deviceId&&t.some(g=>g.deviceId===c.deviceId)).sort((c,g)=>c.seat-g.seat),[s,t]),i=({active:c,payload:g})=>!c||!g||g.length===0?null:e.jsxs("article",{className:"heart-rate-tooltip",children:[e.jsxs("p",{className:"heart-rate-tooltip-title",children:["Time: ",g[0]?.payload?.timestampStr]}),g.map(r=>{const d=r.dataKey.replace("device_",""),j=N.find(x=>x.deviceId===d);return!j||r.value===void 0?null:e.jsxs("div",{className:"heart-rate-tooltip-item",children:[e.jsx("div",{className:"heart-rate-tooltip-indicator",style:{backgroundColor:r.color}}),e.jsxs("div",{children:[e.jsxs("p",{className:"heart-rate-tooltip-text",children:[j.name," (Seat ",j.seat,"): ",r.value," BPM"]}),e.jsxs("p",{className:"heart-rate-tooltip-text",children:["Zone: ",r.value<120?"Recovery":r.value<150?"Aerobic":r.value<170?"Threshold":"Anaerobic"]})]})]},r.dataKey)})]}),l=({payload:c})=>{if(!c||c.length===0)return null;const g=c.map(r=>{const d=r.dataKey.replace("device_",""),j=N.find(x=>x.deviceId===d);return{entry:r,rower:j}}).filter(r=>r.rower).sort((r,d)=>r.rower.seat-d.rower.seat);return e.jsx("div",{className:"heart-rate-legend",children:g.map(({entry:r,rower:d})=>e.jsxs("div",{className:"heart-rate-legend-item",children:[e.jsx("div",{className:"heart-rate-legend-indicator",style:{backgroundColor:r.color}}),e.jsxs("span",{className:"heart-rate-legend-text",children:[d.name," (Seat ",d.seat,")"]})]},r.dataKey))})},v=({viewBox:c})=>{const{x:g,y:r,width:d,height:j}=c;return e.jsxs("text",{x:g+d/2,y:r+j,textAnchor:"middle",fontSize:"12",fill:"var(--color-blue-light)",children:["Session Duration: ",o,"s"]})};return h.length===0?e.jsxs("section",{className:"heart-rate-chart",children:[e.jsx("h3",{className:"heart-rate-chart-title",children:"Heart Rate Trend"}),e.jsxs("article",{className:"heart-rate-chart-empty",children:[e.jsx("span",{className:"heart-rate-chart-empty-icon",children:"📈"}),e.jsx("p",{className:"heart-rate-chart-empty-text",children:"No session data available"}),e.jsx("p",{className:"heart-rate-chart-empty-subtext",children:"Complete a training session to see heart rate analysis"})]})]}):e.jsxs("section",{className:"heart-rate-chart",children:[e.jsxs("header",{className:"heart-rate-chart-header",children:[e.jsx("h3",{className:"heart-rate-chart-title",children:"Session Analysis"}),e.jsxs("div",{className:"heart-rate-chart-subtitle",children:[N.length," rower",N.length!==1?"s":""," active"]})]}),e.jsx("article",{className:"heart-rate-chart-container",children:e.jsx(je,{width:"100%",height:"100%",children:e.jsxs(pe,{data:h,children:[e.jsx(Ne,{strokeDasharray:"3 3",stroke:"var(--color-blue-light)"}),e.jsx(we,{dataKey:"duration",tick:{fontSize:11,fill:"var(--color-blue-light)"},tickLine:{stroke:"var(--color-blue-light)"},axisLine:{stroke:"var(--color-blue-light)"},domain:[0,o],scale:"linear",ticks:u,label:e.jsx(v,{})}),e.jsx(be,{domain:[80,200],tick:{fontSize:12,fill:"var(--color-blue-light)"},tickLine:{stroke:"var(--color-blue-light)"},axisLine:{stroke:"var(--color-blue-light)"}}),e.jsx(Re,{content:e.jsx(i,{})}),e.jsx(ye,{content:e.jsx(l,{})}),N.map(c=>e.jsx(He,{type:"monotone",dataKey:`device_${c.deviceId}`,stroke:_e[c.seat]||"#6b7280",strokeWidth:2,name:`${c.name} (Seat ${c.seat})`,connectNulls:!1,dot:!1,activeDot:{r:5,strokeWidth:2},animationDuration:1e3,animationEasing:"ease-out",isAnimationActive:!0},c.deviceId))]})})})]})},(t,s)=>t.data===s.data&&t.rowers===s.rowers&&t.sessionStartTime?.getTime()===s.sessionStartTime?.getTime()&&t.sessionEndTime?.getTime()===s.sessionEndTime?.getTime()),Ge=()=>{const[t,s]=a.useState(!1),[m,n]=a.useState(!1),[h,o]=a.useState(null),[u,N]=a.useState([]),i=a.useCallback(async()=>{if(t)try{n(!0);const f=await B();N(f)}catch(f){o(f instanceof Error?f.message:"Failed to load sessions")}finally{n(!1)}},[t]);a.useEffect(()=>{(async()=>{try{n(!0),await ge(),s(!0)}catch(p){o(p instanceof Error?p.message:"Failed to initialize database")}finally{n(!1)}})()},[]),a.useEffect(()=>{i()},[i]);const l=a.useCallback(async f=>{if(t)try{await ee(f)}catch(p){o(p instanceof Error?p.message:"Failed to store heart rate data")}},[t]),v=a.useCallback(async f=>{if(t)try{await te(f)}catch(p){o(p instanceof Error?p.message:"Failed to store heart rate data batch")}},[t]),c=a.useCallback(async f=>{if(!t)return[];try{return await ae(f)}catch(p){return o(p instanceof Error?p.message:"Failed to retrieve session heart rate data"),[]}},[t]),g=a.useCallback(async(f,p)=>{if(!t)return[];try{return await se(f,p)}catch(H){return o(H instanceof Error?H.message:"Failed to retrieve device heart rate data"),[]}},[t]),r=a.useCallback(async(f,p,H)=>{if(!t)return[];try{return await ne(f,p,H)}catch(C){return o(C instanceof Error?C.message:"Failed to retrieve heart rate data in range"),[]}},[t]),d=a.useCallback(async f=>{if(t)try{await re(f)}catch(p){o(p instanceof Error?p.message:"Failed to store training session")}},[t]),j=a.useCallback(async()=>{if(!t)return[];try{return await B()}catch(f){return o(f instanceof Error?f.message:"Failed to retrieve sessions"),[]}},[t]),x=a.useCallback(async f=>{if(t)try{return await ce(f)}catch(p){o(p instanceof Error?p.message:"Failed to retrieve session");return}},[t]),w=a.useCallback(async(f=10)=>{if(!t)return[];try{return await oe(f)}catch(p){return o(p instanceof Error?p.message:"Failed to retrieve recent sessions"),[]}},[t]),y=a.useCallback(async f=>{if(t)try{await ie(f)}catch(p){o(p instanceof Error?p.message:"Failed to store rower profile")}},[t]),b=a.useCallback(async()=>{if(!t)return[];try{return await le()}catch(f){return o(f instanceof Error?f.message:"Failed to retrieve rower profiles"),[]}},[t]),R=a.useCallback(async f=>{if(t)try{return await de(f)}catch(p){o(p instanceof Error?p.message:"Failed to retrieve rower profile");return}},[t]),M=a.useCallback(async f=>{if(t)try{await me(f)}catch(p){o(p instanceof Error?p.message:"Failed to delete session")}},[t]),k=a.useCallback(async()=>{if(!t)return null;try{return await he()}catch(f){return o(f instanceof Error?f.message:"Failed to retrieve database statistics"),null}},[t]),S=a.useCallback(async()=>{if(t)try{await ue()}catch(f){o(f instanceof Error?f.message:"Failed to clear database")}},[t]);return{isInitialized:t,isLoading:m,error:h,sessions:u,storeHeartRate:l,storeHeartRateBatch:v,getSessionHeartRateData:c,getDeviceHeartRateData:g,getHeartRateDataInTimeRange:r,storeTrainingSession:d,getAllTrainingSessions:j,getTrainingSession:x,getRecentTrainingSessions:w,deleteTrainingSession:M,storeRowerProfile:y,getAllRowerProfiles:b,getRowerProfile:R,getStats:k,clearDatabase:S}},Xe={recovery:"#10b981",aerobic:"#3b82f6",threshold:"#f59e0b",anaerobic:"#ef4444"},qe=({currentSession:t})=>{const{zones:s}=X(),{sessions:m}=Ge(),[n,h]=a.useState(null),o=a.useMemo(()=>{if(!t?.finalHeartRateData||t.finalHeartRateData.length===0)return null;const i=t.finalHeartRateData,l=i.map(x=>x.heartRate),v=Math.round(l.reduce((x,w)=>x+w,0)/l.length),c=Math.max(...l),g=Math.min(...l),r=t.rowers.map(x=>{const w=i.filter(H=>H.deviceId===x.deviceId);if(w.length===0)return null;const y=w.map(H=>H.heartRate),b=Math.round(y.reduce((H,C)=>H+C,0)/y.length),R=Math.max(...y),M=Math.min(...y),k={recovery:0,aerobic:0,threshold:0,anaerobic:0};w.forEach(H=>{const C=H.heartRate;C>=s.anaerobic.min?k.anaerobic++:C>=s.threshold.min?k.threshold++:C>=s.aerobic.min?k.aerobic++:k.recovery++});const S=w.length,f=t.endTime?Math.floor((t.endTime.getTime()-t.startTime.getTime())/1e3):0,p=Object.entries(k).map(([H,C])=>{const J=S>0?Math.round(C/S*100):0,F=S>0?Math.round(C/S*f):0,L=Math.floor(F/60),Z=F%60;return{zone:H,count:C,percentage:J,durationSeconds:F,durationFormatted:L>0?`${L}m ${Z}s`:`${Z}s`}});return{rower:x,avgHeartRate:b,maxHeartRate:R,minHeartRate:M,dataPoints:w.length,zoneBreakdown:p}}).filter(Boolean),d=i.length,j={recovery:i.filter(x=>x.heartRate<s.aerobic.min).length,aerobic:i.filter(x=>x.heartRate>=s.aerobic.min&&x.heartRate<s.threshold.min).length,threshold:i.filter(x=>x.heartRate>=s.threshold.min&&x.heartRate<s.anaerobic.min).length,anaerobic:i.filter(x=>x.heartRate>=s.anaerobic.min).length};return{avgHeartRate:v,maxHeartRate:c,minHeartRate:g,totalDataPoints:d,zoneTime:j,rowerMetrics:r,sessionDuration:t.endTime?Math.floor((t.endTime.getTime()-t.startTime.getTime())/1e3/60):0}},[t,s]),u=a.useMemo(()=>{if(!n||!m||!o)return null;const i=m.find(x=>x.id===n);if(!i||!i.finalHeartRateData)return null;const l=i.finalHeartRateData,v=Math.round(l.reduce((x,w)=>x+w.heartRate,0)/l.length),c=Math.max(...l.map(x=>x.heartRate)),g=i.endTime?Math.floor((i.endTime.getTime()-i.startTime.getTime())/1e3/60):0,r=Math.round((o.avgHeartRate-v)/v*100),d=Math.round((o.maxHeartRate-c)/c*100),j=g>0?Math.round((o.sessionDuration-g)/g*100):0;return{avgHeartRate:r,maxHeartRate:d,duration:j}},[n,m,o]),N=a.useMemo(()=>{if(!n||!m||!o?.rowerMetrics)return null;const i=m.find(l=>l.id===n);return!i||!i.finalHeartRateData?null:o.rowerMetrics.map(l=>{if(!l)return null;const v=i.finalHeartRateData.filter(j=>j.deviceId===l.rower.deviceId);if(v.length===0)return null;const c=Math.round(v.reduce((j,x)=>j+x.heartRate,0)/v.length),g=Math.max(...v.map(j=>j.heartRate)),r=Math.round((l.avgHeartRate-c)/c*100),d=Math.round((l.maxHeartRate-g)/g*100);return{rowerId:l.rower.id,avgHeartRate:r,maxHeartRate:d}}).filter(Boolean)},[n,m,o]);return t?e.jsxs("section",{className:"enhanced-dashboard",children:[o&&e.jsxs("section",{className:"card-base performance-metrics",children:[e.jsxs("h3",{className:"card-title",children:[e.jsx(O,{className:"card-title-icon"}),"Performance Metrics"]}),e.jsxs("div",{className:"metrics-grid",children:[e.jsxs("div",{className:"metric-item",children:[e.jsx(A,{className:"metric-icon"}),e.jsxs("div",{className:"metric-content",children:[e.jsx("p",{className:"metric-value",children:o.avgHeartRate}),e.jsx("p",{className:"metric-label",children:"Avg BPM"}),u&&e.jsxs("div",{className:`progress-indicator ${u.avgHeartRate===0?"neutral":u.avgHeartRate<0?"improvement":"decline"}`,children:[e.jsx("span",{className:"progress-icon",children:u.avgHeartRate===0?"—":u.avgHeartRate<0?"↗":"↘"}),e.jsxs("span",{className:"progress-text",children:[Math.abs(u.avgHeartRate),"%"]})]})]})]}),e.jsxs("div",{className:"metric-item",children:[e.jsx(Le,{className:"metric-icon"}),e.jsxs("div",{className:"metric-content",children:[e.jsx("p",{className:"metric-value",children:o.maxHeartRate}),e.jsx("p",{className:"metric-label",children:"Max BPM"}),u&&e.jsxs("div",{className:`progress-indicator ${u.maxHeartRate===0?"neutral":u.maxHeartRate<0?"improvement":"decline"}`,children:[e.jsx("span",{className:"progress-icon",children:u.maxHeartRate===0?"—":u.maxHeartRate<0?"↗":"↘"}),e.jsxs("span",{className:"progress-text",children:[Math.abs(u.maxHeartRate),"%"]})]})]})]}),e.jsxs("div",{className:"metric-item",children:[e.jsx(Fe,{className:"metric-icon"}),e.jsxs("div",{className:"metric-content",children:[e.jsxs("p",{className:"metric-value",children:[o.sessionDuration,"m"]}),e.jsx("p",{className:"metric-label",children:"Duration"}),u&&e.jsxs("div",{className:`progress-indicator ${u.duration===0?"neutral":u.duration>0?"improvement":"decline"}`,children:[e.jsx("span",{className:"progress-icon",children:u.duration===0?"—":u.duration>0?"↗":"↘"}),e.jsxs("span",{className:"progress-text",children:[Math.abs(u.duration),"%"]})]})]})]}),e.jsxs("div",{className:"metric-item",children:[e.jsx(I,{className:"metric-icon"}),e.jsxs("div",{className:"metric-content",children:[e.jsx("p",{className:"metric-value",children:o.totalDataPoints}),e.jsx("p",{className:"metric-label",children:"Data Points"})]})]})]})]}),o?.rowerMetrics&&o.rowerMetrics.length>0&&e.jsxs("section",{className:"card-base rower-metrics",children:[e.jsxs("h3",{className:"card-title",children:[e.jsx(A,{className:"card-title-icon"}),"Individual Rower Performance"]}),e.jsx("div",{className:"rower-metrics-grid",children:o.rowerMetrics.map(i=>i?e.jsxs("div",{className:"rower-metric-card",children:[e.jsxs("div",{className:"rower-metric-header",children:[e.jsx("h4",{className:"rower-metric-name",children:i.rower.name}),e.jsxs("span",{className:"rower-metric-seat",children:["Seat ",i.rower.seat]})]}),e.jsxs("div",{className:"rower-metric-stats",children:[e.jsxs("div",{className:"rower-metric-stat",children:[e.jsx("span",{className:"rower-metric-stat-value",children:i.avgHeartRate}),e.jsx("span",{className:"rower-metric-stat-label",children:"Avg BPM"}),N&&(()=>{const l=N.find(v=>v?.rowerId===i.rower.id);return l?e.jsxs("div",{className:`progress-indicator ${l.avgHeartRate===0?"neutral":l.avgHeartRate<0?"improvement":"decline"}`,children:[e.jsx("span",{className:"progress-icon",children:l.avgHeartRate===0?"—":l.avgHeartRate<0?"↗":"↘"}),e.jsxs("span",{className:"progress-text",children:[Math.abs(l.avgHeartRate),"%"]})]}):null})()]}),e.jsxs("div",{className:"rower-metric-stat",children:[e.jsx("span",{className:"rower-metric-stat-value",children:i.maxHeartRate}),e.jsx("span",{className:"rower-metric-stat-label",children:"Max BPM"}),N&&(()=>{const l=N.find(v=>v?.rowerId===i.rower.id);return l?e.jsxs("div",{className:`progress-indicator ${l.maxHeartRate===0?"neutral":l.maxHeartRate<0?"improvement":"decline"}`,children:[e.jsx("span",{className:"progress-icon",children:l.maxHeartRate===0?"—":l.maxHeartRate<0?"↗":"↘"}),e.jsxs("span",{className:"progress-text",children:[Math.abs(l.maxHeartRate),"%"]})]}):null})()]}),e.jsxs("div",{className:"rower-metric-stat",children:[e.jsx("span",{className:"rower-metric-stat-value",children:i.dataPoints}),e.jsx("span",{className:"rower-metric-stat-label",children:"Data Points"})]})]}),e.jsxs("div",{className:"rower-zone-breakdown",children:[e.jsx("h5",{className:"rower-zone-breakdown-title",children:"Heart Rate Zones"}),e.jsx("div",{className:"rower-zone-list",children:i.zoneBreakdown.map(l=>e.jsxs("div",{className:"rower-zone-item",children:[e.jsxs("div",{className:"rower-zone-header",children:[e.jsx("span",{className:"rower-zone-color",style:{backgroundColor:Xe[l.zone]}}),e.jsx("span",{className:"rower-zone-name",children:l.zone.charAt(0).toUpperCase()+l.zone.slice(1)})]}),e.jsxs("div",{className:"rower-zone-details",children:[e.jsxs("span",{className:"rower-zone-percentage",children:[l.percentage,"%"]}),e.jsx("span",{className:"rower-zone-duration",children:l.durationFormatted})]})]},l.zone))})]})]},i.rower.id):null)})]}),t&&!t.isActive&&t.finalHeartRateData&&t.finalHeartRateData.length>0&&e.jsx(q,{data:t.finalHeartRateData,rowers:t.rowers,sessionStartTime:t.startTime,sessionEndTime:t.endTime}),m&&m.length>0&&e.jsxs("section",{className:"card-base session-selection",children:[e.jsxs("h3",{className:"card-title",children:[e.jsx(O,{className:"card-title-icon"}),"Compare with Previous Session"]}),e.jsx("div",{className:"session-selection-grid",children:m.filter(i=>i.id!==t.id).map(i=>e.jsx("div",{className:`session-selection-card ${n===i.id?"selected":""}`,onClick:()=>h(n===i.id?null:i.id),children:e.jsxs("div",{className:"session-selection-header",children:[e.jsx("input",{type:"radio",name:"session-comparison",checked:n===i.id,onChange:()=>h(n===i.id?null:i.id),className:"session-selection-radio"}),e.jsxs("div",{className:"session-selection-info",children:[e.jsxs("span",{className:"session-selection-date",children:[i.startTime.toLocaleDateString()," ",i.startTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),e.jsxs("span",{className:"session-selection-details",children:[i.rowers.length," rowers • ",i.finalHeartRateData?.length||0," data points"]})]})]})},i.id))})]})]}):e.jsxs("section",{className:"card-base empty-state",children:[e.jsx(I,{className:"empty-state-icon"}),e.jsx("h3",{className:"empty-state-title",children:"No Active Session"}),e.jsx("p",{className:"empty-state-description",children:"Start a training session to view enhanced analytics and trends."})]})},Y=()=>{const[t,s]=a.useState(new Map),[m,n]=a.useState(!1),h=xe.getInstance(),{connectionStatus:o}=D(),u=a.useCallback(()=>{const d=new Map,j=h.getAllConnectionHealth();for(const[x,w]of j){const y=Date.now()-w.lastHeartbeat.getTime(),b=h.isConnectionHealthy(x);d.set(x,{deviceId:x,isHealthy:b,lastHeartbeat:w.lastHeartbeat,timeSinceLastHeartbeat:y})}s(d)},[h]),N=a.useCallback(()=>{n(!0),h.startConnectionHealthMonitoring();const d=setInterval(u,5e3);return()=>{clearInterval(d),h.stopConnectionHealthMonitoring(),n(!1)}},[h,u]),i=a.useCallback(()=>{h.stopConnectionHealthMonitoring(),n(!1)},[h]),l=a.useCallback(d=>t.get(d),[t]),v=a.useCallback(()=>Array.from(t.values()).filter(d=>!d.isHealthy),[t]),c=a.useCallback(()=>{const d=t.size,j=Array.from(t.values()).filter(w=>w.isHealthy).length,x=d-j;return{total:d,healthy:j,unhealthy:x,healthPercentage:d>0?Math.round(j/d*100):100}},[t]),g=a.useMemo(()=>{const d=new Map;for(const[j,x]of t)x.isHealthy?d.set(j,{status:"healthy",color:"green"}):d.set(j,{status:"unhealthy",color:"red"});return d},[t]),r=a.useCallback(d=>g.get(d)||{status:"unknown",color:"gray"},[g]);return a.useEffect(()=>{if(o.connectedDevices.length>0){h.startConnectionHealthMonitoring(),u();const j=setInterval(u,5e3);return()=>{clearInterval(j),h.stopConnectionHealthMonitoring()}}else h.stopConnectionHealthMonitoring()},[o.connectedDevices.length,h,u]),a.useEffect(()=>{n(o.connectedDevices.length>0)},[o.connectedDevices.length]),{connectionHealth:t,isMonitoring:m,startMonitoring:N,stopMonitoring:i,getDeviceHealth:l,getDeviceHealthStatus:r,getUnhealthyConnections:v,getHealthSummary:c,updateHealthData:u}},Ye=()=>{const{connectionStatus:t}=D(),{getHealthSummary:s,getUnhealthyConnections:m}=Y(),{isScanning:n,connectedDevices:h,availableDevices:o,hasSpeedCoachConflicts:u,conflicts:N}=t,i=s(),l=m(),v=()=>u?E:l.length>0?P:h.length>0?T:n?ve:G,c=()=>u?"SpeedCoach conflicts detected":l.length>0?`${l.length} connection(s) unhealthy`:h.length>0?`${h.length} device(s) connected (${i.healthPercentage}% healthy)`:n?"Scanning for devices...":"No devices connected",g=v();return e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"connection-status-content",children:[e.jsxs("article",{className:"connection-status-info",children:[e.jsx(g,{className:`connection-status-icon ${u?"connection-status-icon--conflict":l.length>0?"connection-status-icon--unhealthy":h.length>0?"connection-status-icon--connected":n?"connection-status-icon--scanning":"connection-status-icon--disconnected"}`}),e.jsxs("div",{children:[e.jsx("p",{className:`connection-status-text ${u?"connection-status-text--conflict":l.length>0?"connection-status-text--unhealthy":h.length>0?"connection-status-text--connected":n?"connection-status-text--scanning":"connection-status-text--disconnected"}`,children:c()}),o.length>0&&e.jsxs("p",{className:"connection-status-subtitle",children:[o.length," device(s) available"]})]})]}),h.length>0&&e.jsx("ul",{className:"connection-device-list",children:h.map(r=>{const d=r.isHealthy!==!1;return e.jsxs("li",{className:`connection-device-item ${d?"connection-device-item--healthy":"connection-device-item--unhealthy"}`,children:[e.jsx("div",{className:`connection-device-indicator ${d?"connection-device-indicator--healthy":"connection-device-indicator--unhealthy"}`}),e.jsx("p",{className:`connection-device-name ${d?"connection-device-name--healthy":"connection-device-name--unhealthy"}`,children:r.name})]},r.id)})})]}),l.length>0&&e.jsx("section",{className:"connection-issues",children:e.jsxs("article",{className:"connection-issue",children:[e.jsx(P,{className:"connection-issue-icon connection-issue-icon--error"}),e.jsxs("div",{className:"connection-issue-content",children:[e.jsx("p",{className:"connection-issue-title connection-issue-title--error",children:"Unhealthy connections detected:"}),e.jsx("ul",{className:"connection-issue-list",children:l.map(r=>e.jsxs("li",{className:"connection-issue-item connection-issue-item--error",children:["• Device ",r.deviceId," - Last heartbeat: ",Math.round(r.timeSinceLastHeartbeat/1e3),"s ago"]},r.deviceId))})]})]})}),u&&N.length>0&&e.jsx("section",{className:"connection-issues",children:e.jsxs("article",{className:"connection-issue",children:[e.jsx(E,{className:"connection-issue-icon connection-issue-icon--warning"}),e.jsxs("div",{className:"connection-issue-content",children:[e.jsx("p",{className:"connection-issue-title connection-issue-title--warning",children:"Connection conflicts detected:"}),e.jsx("ul",{className:"connection-issue-list",children:N.map(r=>e.jsxs("li",{className:"connection-issue-item connection-issue-item--warning",children:["• ",r.deviceName," is connected to SpeedCoach"]},r.deviceId))})]})]})})]})},Je=()=>{const{connectionStatus:t}=D(),{attemptReconnection:s}=fe(),{getUnhealthyConnections:m}=Y(),[n,h]=a.useState(new Map),[o,u]=a.useState(new Map),N=m(),i=async v=>{h(c=>new Map(c).set(v,!0));try{const c=await s(v);u(g=>new Map(g).set(v,c)),setTimeout(()=>{u(g=>{const r=new Map(g);return r.delete(v),r})},3e3)}catch(c){console.error("Manual reconnection failed:",c),u(g=>new Map(g).set(v,!1))}finally{h(c=>{const g=new Map(c);return g.delete(v),g})}},l=async()=>{for(const v of N)await i(v.deviceId)};return N.length===0?null:e.jsxs("section",{className:"card-base reconnection-status",children:[e.jsxs("article",{className:"reconnection-status-header",children:[e.jsxs("div",{className:"reconnection-status-title",children:[e.jsx(E,{className:"reconnection-status-icon"}),e.jsx("h3",{className:"reconnection-status-text",children:"Connection Issues Detected"})]}),N.length>1&&e.jsx("div",{className:"reconnection-status-actions",children:e.jsxs("button",{onClick:l,className:"btn btn-secondary",style:{color:"var(--status-error)",borderColor:"var(--status-error)"},children:[e.jsx($,{className:"reconnection-icon"}),"Reconnect All"]})})]}),e.jsx("ul",{className:"reconnection-device-list",children:N.map(v=>{const c=n.get(v.deviceId),g=o.get(v.deviceId),r=t.connectedDevices.find(d=>d.id===v.deviceId);return e.jsxs("li",{className:"reconnection-device-item",children:[e.jsxs("div",{className:"reconnection-device-info",children:[e.jsx("div",{className:"reconnection-device-indicator"}),e.jsxs("div",{className:"reconnection-device-details",children:[e.jsx("p",{className:"reconnection-device-name",children:r?.name||`Device ${v.deviceId}`}),e.jsxs("p",{className:"reconnection-device-timeout",children:["Last heartbeat: ",Math.round(v.timeSinceLastHeartbeat/1e3),"s ago"]})]})]}),e.jsxs("div",{className:"reconnection-device-actions",children:[g===!0&&e.jsxs("div",{className:"reconnection-result reconnection-result--success",children:[e.jsx(T,{className:"reconnection-result-icon"}),e.jsx("span",{className:"reconnection-result-text",children:"Reconnected"})]}),g===!1&&e.jsxs("div",{className:"reconnection-result reconnection-result--failure",children:[e.jsx(Oe,{className:"reconnection-result-icon"}),e.jsx("span",{className:"reconnection-result-text",children:"Failed"})]}),e.jsx("button",{onClick:()=>i(v.deviceId),disabled:c,className:"reconnection-button",children:c?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"reconnection-button-icon reconnection-button-icon--spinning"}),"Reconnecting..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"reconnection-button-icon"}),"Reconnect"]})})]})]},v.deviceId)})})]})},Qe=()=>!1,et=()=>Qe(),tt=()=>{const{rowers:t,currentSession:s,startSession:m,endSession:n,updateHeartRate:h,addRower:o,removeAllRowers:u,setConnectionStatus:N,addConnectedDevice:i,removeAllConnectedDevices:l,clearHeartRateData:v}=D(),[c,g]=a.useState(et()),[r,d]=a.useState(null),[j,x]=a.useState(!1);return null},ot=()=>{const{currentSession:t,rowers:s,connectionStatus:m,startSession:n,endSession:h,setUIState:o,getUnhealthyDevices:u,sessionWasRestored:N}=D(),{zones:i}=X(),l=Ue(t),v=t?.isActive,[c,g]=a.useState(!1),[r,d]=a.useState(!1),j=u();a.useEffect(()=>{N&&t&&(d(!0),setTimeout(()=>d(!1),5e3))},[N,t]);const x=()=>{if(s.length===0){o({currentView:"setup"});return}d(!1);const b={id:`session-${Date.now()}`,startTime:new Date,rowers:s,heartRateData:[],isActive:!0};n(b)},w=()=>{h()},y=s.filter(b=>b.deviceId&&b.currentHeartRate);return e.jsxs(e.Fragment,{children:[e.jsx(tt,{}),e.jsxs("section",{className:"session-controls",children:[r&&e.jsxs("div",{className:"session-restoration-notification",children:[e.jsx(T,{className:"restoration-icon"}),e.jsx("span",{children:"Session restored from previous session"})]}),e.jsxs("article",{className:"session-info",children:[e.jsx("h2",{className:"session-title",children:"Training Session"}),e.jsx("p",{className:"session-subtitle",children:v?`Started ${t?.startTime.toLocaleTimeString()}`:t&&!v?`Session ended - Duration: ${l}`:"Ready to start monitoring"}),v&&e.jsxs("div",{className:"session-status",children:[e.jsxs("p",{className:"status-indicator",children:[e.jsx(T,{className:"status-icon"}),e.jsxs("span",{className:"status-text status-text--success",children:[y.length," rower(s) active"]})]}),e.jsx("p",{className:"status-indicator",children:e.jsxs("span",{className:"status-text status-text--info",children:["Duration: ",l]})}),j.length>0&&e.jsxs("p",{className:"status-indicator",children:[e.jsx(E,{className:"status-icon"}),e.jsxs("span",{className:"status-text status-text--error",children:[j.length," connection(s) unhealthy"]})]})]})]}),e.jsxs("article",{className:"session-actions",children:[v?e.jsxs("button",{onClick:w,className:"btn btn-danger",children:[e.jsx(Pe,{className:"btn-icon"}),"End Session"]}):e.jsxs("button",{onClick:x,disabled:m.connectedDevices.length===0,className:"btn btn-primary",children:[e.jsx(ze,{className:"btn-icon"}),"Start Session"]}),e.jsxs("button",{onClick:()=>o({currentView:"setup"}),className:"btn btn-secondary",children:[e.jsx(V,{className:"btn-icon"}),"Add Rower"]}),t&&e.jsx("button",{onClick:()=>g(!c),className:`btn ${c?"btn-primary":"btn-secondary"}`,children:c?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"btn-icon"}),"Basic View"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"btn-icon"}),"Enhanced View"]})})]})]}),e.jsx(Ye,{}),e.jsx(Je,{}),s.length>0?e.jsx(e.Fragment,{children:c&&t?e.jsx(qe,{currentSession:t}):e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"rower-overview",children:[e.jsx("h3",{className:"rower-overview-title",children:"Rower Status"}),e.jsx("article",{className:"rower-grid",children:[1,2,3,4].map(b=>{const R=s.find(S=>S.seat===b),M=R&&R.deviceId&&R.currentHeartRate,k=R&&R.deviceId;return e.jsxs("div",{className:`rower-seat ${M?"rower-seat--connected":k?"rower-seat--device-only":"rower-seat--empty"}`,children:[e.jsx("span",{className:`rower-status-indicator ${M?"rower-status-indicator--connected":k?"rower-status-indicator--device-only":"rower-status-indicator--empty"}`}),e.jsxs("p",{className:"rower-seat-number",children:["Seat ",b]}),e.jsx("p",{className:"rower-name",children:R?R.name:"Empty"}),e.jsx("p",{className:"rower-status",children:M?"Active":k?"Connected":"No Device"})]},b)})})]}),y.length>0&&e.jsx("section",{className:"heart-rate-grid",children:y.map(b=>e.jsx(Ke,{rower:b,zones:i},b.id))}),t&&!t.isActive&&t.finalHeartRateData&&t.finalHeartRateData.length>0&&e.jsx(q,{data:t.finalHeartRateData,rowers:t.rowers,sessionStartTime:t.startTime,sessionEndTime:t.endTime})]})}):e.jsxs("section",{className:"card-base empty-state",children:[e.jsx(I,{className:"empty-state-icon"}),e.jsx("h3",{className:"empty-state-title",children:"No heart rate data"}),e.jsx("p",{className:"empty-state-description",children:"Connect heart rate devices and assign them to rowers to start monitoring."}),e.jsx("div",{className:"empty-state-action",children:e.jsxs("button",{onClick:()=>o({currentView:"setup"}),className:"btn btn-primary",children:[e.jsx(V,{className:"btn-icon"}),"Setup Devices"]})})]}),e.jsxs("section",{className:"card-base heart-rate-zones",children:[e.jsx("h3",{className:"heart-rate-zones-title",children:"Heart Rate Zones"}),e.jsx("article",{className:"heart-rate-zones-grid",children:Object.entries(i).map(([b,R])=>e.jsxs("div",{className:"heart-rate-zone-item",children:[e.jsx("span",{className:`heart-rate-zone-color ${R.name.toLowerCase()}`}),e.jsx("p",{className:"heart-rate-zone-name",children:R.name}),e.jsxs("p",{className:"heart-rate-zone-range",children:[R.min,"-",R.max," BPM"]})]},b))})]})]})};export{ot as Dashboard};
